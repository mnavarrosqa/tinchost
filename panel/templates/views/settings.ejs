<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings – Tinchost Panel</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #eef5ef; color: #1b4332; }
    <%- include('partials/nav-styles') %>
    main { max-width: 720px; margin: 0 auto; padding: 1.5rem; background: #fff; min-height: 80vh; border: 1px solid #b7d4bc; border-top: none; }
    h1 { margin-top: 0; color: #1b4332; font-size: 1.5rem; }
    h2 { color: #2d6a4f; font-size: 1.1rem; margin: 1.5rem 0 0.75rem 0; }
    label { display: block; margin-top: 0.75rem; font-size: 0.9rem; color: #1b4332; }
    input[type=text], input[type=password] { width: 100%; max-width: 360px; padding: 0.5rem; border: 1px solid #b7d4bc; border-radius: 4px; }
    button, .btn { padding: 0.45rem 0.9rem; background: #2d6a4f; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    button:hover, .btn:hover { background: #1b4332; color: #fff; }
    .risk { background: #f8d7da; border: 1px solid #9b2226; color: #9b2226; padding: 0.75rem; margin: 1rem 0; border-radius: 4px; font-size: 0.9rem; }
    .success { background: #d8f3dc; border: 1px solid #2d6a4f; color: #1b4332; padding: 0.5rem 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #e8f5e9; }
    th { color: #2d6a4f; font-weight: 600; font-size: 0.875rem; }
    .status-active { color: #2d6a4f; font-weight: 500; }
    .status-inactive { color: #9b2226; }
    .card { border: 1px solid #b7d4bc; border-radius: 6px; padding: 1.25rem; margin-bottom: 1.25rem; background: #fff; }
    form.inline { display: inline; }
    .tabs { margin: 0 0 0 0; border-bottom: 1px solid #b7d4bc; }
    .tabs-list { display: flex; flex-wrap: wrap; gap: 0; list-style: none; margin: 0; padding: 0; }
    .tabs-list li { margin: 0; }
    .tabs-trigger { padding: 0.75rem 1rem; color: #52796f; text-decoration: none; border-bottom: 3px solid transparent; margin-bottom: -1px; display: flex; align-items: center; gap: 0.4rem; font-size: 0.95rem; }
    .tabs-trigger:hover { color: #2d6a4f; }
    .tabs-trigger.is-active { color: #2d6a4f; font-weight: 600; border-bottom-color: #2d6a4f; }
    .tabs-trigger .ic { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .tabs-panel { display: none; padding-top: 1.25rem; }
    .tabs-panel.is-active { display: block; }
    .service-action-cell { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
    .service-action-cell form { margin: 0; }
    .service-feedback { font-size: 0.85rem; margin: 0; }
    .service-feedback.loading { color: #52796f; font-style: italic; }
    .service-feedback.success { color: #2d6a4f; font-weight: 500; }
    .service-feedback.error { color: #9b2226; }
    .service-action-cell button[disabled] { opacity: 0.8; cursor: not-allowed; }
  </style>
</head>
<body>
  <%- include('partials/nav') %>
  <main>
    <h1>Settings</h1>
    <% if (typeof settingsError === 'string' && settingsError) { %>
    <div class="risk"><strong>Error:</strong> <%= settingsError %></div>
    <% } %>
    <% if (typeof serviceError === 'string' && serviceError) { %>
    <div class="risk"><strong>Service:</strong> <%= serviceError %></div>
    <% } %>
    <% if (typeof saved !== 'undefined' && saved) { %>
    <p class="success"><%= typeof saved === 'string' ? saved : 'Settings saved.' %></p>
    <% } %>
    <% if (typeof serviceRestarted === 'string' && serviceRestarted) { %>
    <p class="success">Service <strong><%= serviceRestarted %></strong> restarted.</p>
    <% } %>
    <% if (typeof settingsInstalled === 'string' && settingsInstalled) { %>
    <% const installedLabel = settingsInstalled === 'php' ? 'PHP-FPM' : settingsInstalled === 'node' ? 'Node.js' : settingsInstalled === 'database' ? 'Database' : settingsInstalled === 'mail' ? 'Mail' : settingsInstalled === 'ftp' ? 'FTP' : 'Certbot'; %>
    <p class="success">Component <strong><%= installedLabel %></strong> installed successfully.</p>
    <% } %>
    <div class="risk"><strong>This panel runs as root.</strong> Protect access and use a strong password.</div>

    <nav class="tabs" aria-label="Settings sections">
      <ul class="tabs-list">
        <li><a href="#paths" class="tabs-trigger is-active" data-tab="paths" id="tab-paths"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><polyline points="13 2 13 9 20 9"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Paths &amp; credentials</a></li>
        <li><a href="#services" class="tabs-trigger" data-tab="services" id="tab-services"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/><line x1="18" y1="6" x2="18.01" y2="6"/><line x1="18" y1="18" x2="18.01" y2="18"/></svg>Services</a></li>
        <li><a href="#components" class="tabs-trigger" data-tab="components" id="tab-components"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Install components</a></li>
      </ul>
    </nav>

    <div id="panel-paths" class="tabs-panel is-active" role="tabpanel" aria-labelledby="tab-paths">
    <h2>Paths &amp; credentials</h2>
    <% if (typeof dbPath !== 'undefined' && dbPath) { %>
    <p style="font-size:0.85rem; color:#52796f; margin:0 0 0.75rem 0;">Panel database: <code style="word-break:break-all;"><%= dbPath %></code></p>
    <% } %>
    <% if (typeof hasMysqlPassword !== 'undefined' && !hasMysqlPassword) { %>
    <% const dbPathExample = typeof dbPath !== 'undefined' && dbPath ? dbPath : '/opt/tinchohost/panel/data/panel.sqlite'; %>
    <p style="font-size:0.9rem; color:#9b2226; margin:0 0 0.75rem 0;">MySQL root password is not set. Enter it below and click Save. If you saved it before but still see &quot;not set&quot; on other pages, set the <code>DATABASE_PATH</code> environment variable to the full path of your panel database (e.g. <code><%= dbPathExample %></code>) and restart the panel.</p>
    <% } %>
    <% const mysqlPwdValue = (typeof mysqlRootPassword !== 'undefined' && mysqlRootPassword) ? mysqlRootPassword : ''; %>
    <form method="post" action="/settings">
      <label>Nginx sites-available path</label>
      <input type="text" name="nginx_sites_available" value="<%= nginxSites %>">
      <label>PHP pool dir</label>
      <input type="text" name="php_pool_dir" value="<%= phpPoolDir %>">
      <label>Mail path (Maildir base)</label>
      <input type="text" name="mail_path" value="<%= mailPath %>">
      <label>MySQL root password (for creating DBs/users)</label>
      <input type="password" name="mysql_root_password" value="<%= mysqlPwdValue %>" placeholder="Enter password to set or change; leave blank to keep current" autocomplete="new-password">
      <button type="submit">Save</button>
    </form>
    </div>

    <div id="panel-services" class="tabs-panel" role="tabpanel" aria-labelledby="tab-services">
    <h2 id="services">Installed services</h2>
    <p style="color:#52796f; font-size:0.9rem; margin:0 0 0.5rem 0;">Services installed by the wizard. Restart a service to apply config changes.</p>
    <div class="card" style="margin-bottom:1rem;">
      <p style="margin:0 0 0.5rem 0;"><strong>Nginx upload limit</strong> — Getting <em>413 Request Entity Too Large</em> when uploading files (e.g. WordPress media)? Apply a 64M limit globally.</p>
      <form method="post" action="/settings/nginx-upload-limit" class="inline">
        <button type="submit">Apply Nginx upload limit (64M)</button>
      </form>
    </div>
    <div class="card" style="margin-bottom:1rem;">
      <p style="margin:0 0 0.5rem 0;"><strong>PHP mail (default <code>mail()</code>)</strong> — Ensures all PHP versions use the system sendmail (Postfix) so WordPress and other apps can send email. Run this if PHP was installed before Mail, or if emails from PHP are not being sent. If Postfix is running, also sets a default envelope sender for PHP (www-data).</p>
      <form method="post" action="/settings/apply-php-mail" class="inline">
        <button type="submit">Apply PHP mail config</button>
      </form>
      <p style="font-size:0.85rem; color:#52796f; margin:0.5rem 0 0 0;">If WordPress mail still doesn’t arrive, recipients may be blocking it (SPF/spam). Use a plugin like <strong>WP Mail SMTP</strong> or <strong>FluentSMTP</strong> to send via SMTP with a proper From address.</p>
    </div>
    <div class="card" style="margin-bottom:1rem;">
      <p style="margin:0 0 0.5rem 0;"><strong>Test outgoing email</strong> — Send a test message via Postfix to verify that mail is working. Requires Mail (Postfix) to be installed and running.</p>
      <form method="post" action="/settings/test-email" class="inline" style="display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem;">
        <input type="email" name="to" placeholder="your@email.com" required style="padding:0.4rem 0.5rem; border:1px solid #b7d4bc; border-radius:4px; min-width:200px;">
        <button type="submit">Send test email</button>
      </form>
    </div>
    <% if (typeof installedServices !== 'undefined' && installedServices.length) { %>
    <div class="card">
      <table>
        <thead><tr><th>Service</th><th>Status</th><th>Logs</th><th>Action</th></tr></thead>
        <tbody>
          <% installedServices.forEach(function(s) { %>
          <tr data-service-unit="<%= s.unit %>" data-service-label="<%= s.label %>">
            <td><%= s.label %></td>
            <td><span class="service-status <%= s.status === 'active' ? 'status-active' : 'status-inactive' %>" aria-live="polite"><%= s.status === 'active' ? 'Running' : 'Stopped' %></span></td>
            <td><a href="/settings/services/logs?unit=<%= encodeURIComponent(s.unit) %>" target="_blank" rel="noopener" class="btn" style="text-decoration:none; padding:0.35rem 0.65rem; font-size:0.85rem;">View logs</a></td>
            <td>
              <div class="service-action-cell">
                <form method="post" action="/settings/services/restart" class="js-service-restart-form inline">
                  <input type="hidden" name="service" value="<%= s.unit %>">
                  <button type="submit" class="js-restart-btn">Restart</button>
                </form>
                <span class="service-feedback js-service-feedback" role="status" aria-live="polite"></span>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <% } else { %>
    <p style="color:#52796f; font-size:0.9rem;">Complete the <a href="/wizard">setup wizard</a> or install components below. Services will appear here once installed.</p>
    <% } %>
    </div>

    <div id="panel-components" class="tabs-panel" role="tabpanel" aria-labelledby="tab-components">
    <h2>Install components</h2>
    <p style="color:#52796f; font-size:0.9rem; margin:0 0 0.75rem 0;">Install or add components that were not selected during the wizard. Installation may take a few minutes; do not close the page until it finishes.</p>
    <% const phpList = (state && state.php_versions) ? (state.php_versions + '').split(',').map(s => s.trim()).filter(Boolean) : []; %>
    <% const hasPhp = phpList.length > 0; %>
    <% const hasNode = state && state.node_version; %>
    <% const hasDb = state && state.database_choice; %>
    <% const hasMail = state && state.email_installed; %>
    <% const hasFtp = state && state.ftp_installed; %>
    <% const hasCertbot = state && state.certbot_installed; %>
    <% const phpFpmConfig = (state && state.php_fpm_config) || 'default'; %>
    <% const databaseConfig = (state && state.database_config) || 'default'; %>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">PHP-FPM</h3>
      <% if (hasPhp) { %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed: <%= phpList.join(', ') %> · Config: <%= phpFpmConfig %></p>
      <p style="margin:0.5rem 0 0 0; font-size:0.85rem;">To add or change versions, use the form below and submit.</p>
      <% } %>
      <% var _c74 = phpList.includes('7.4') ? 'checked' : ''; var _c81 = phpList.includes('8.1') ? 'checked' : ''; var _c82 = phpList.includes('8.2') ? 'checked' : ''; var _c83 = phpList.includes('8.3') ? 'checked' : ''; var _phpDef = phpFpmConfig === 'default' ? 'checked' : ''; var _phpOpt = phpFpmConfig === 'optimized' ? 'checked' : ''; var _phpBtn = hasPhp ? 'Update PHP-FPM' : 'Install PHP-FPM'; %>
      <form method="post" action="/settings/install/php" style="margin-top:0.75rem;">
        <div style="display:flex; flex-wrap:wrap; gap:0.5rem 1rem;">
          <label class="checkbox-option" style="display:inline-flex; align-items:center; margin:0;"><input type="checkbox" name="versions" value="7.4" <%= _c74 %>> 7.4</label>
          <label class="checkbox-option" style="display:inline-flex; align-items:center; margin:0;"><input type="checkbox" name="versions" value="8.1" <%= _c81 %>> 8.1</label>
          <label class="checkbox-option" style="display:inline-flex; align-items:center; margin:0;"><input type="checkbox" name="versions" value="8.2" <%= _c82 %>> 8.2</label>
          <label class="checkbox-option" style="display:inline-flex; align-items:center; margin:0;"><input type="checkbox" name="versions" value="8.3" <%= _c83 %>> 8.3</label>
        </div>
        <div style="margin-top:0.5rem;">
          <label style="margin-right:0.75rem;"><input type="radio" name="php_fpm_config" value="default" <%= _phpDef %>> Default</label>
          <label><input type="radio" name="php_fpm_config" value="optimized" <%= _phpOpt %>> Optimized</label>
        </div>
        <button type="submit" style="margin-top:0.5rem;"><%= _phpBtn %></button>
      </form>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">Node.js</h3>
      <% if (hasNode) { %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed: Node.js <%= state.node_version %></p>
      <% } else { %>
      <form method="post" action="/settings/install/node">
        <div style="display:flex; flex-wrap:wrap; gap:0.5rem 1rem;">
          <label style="display:inline-flex; align-items:center; margin:0;"><input type="radio" name="node_version" value="22"> 22</label>
          <label style="display:inline-flex; align-items:center; margin:0;"><input type="radio" name="node_version" value="20"> 20</label>
          <label style="display:inline-flex; align-items:center; margin:0;"><input type="radio" name="node_version" value="18"> 18</label>
        </div>
        <button type="submit" style="margin-top:0.5rem;">Install Node.js</button>
      </form>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">Database (MySQL / MariaDB)</h3>
      <% if (hasDb) { %>
      <% const dbLabel = state.database_choice === 'mariadb' ? 'MariaDB' : 'MySQL'; %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed: <%= dbLabel %> · Config: <%= databaseConfig %></p>
      <% } else { %>
      <% const dbDefaultChecked = databaseConfig === 'default' ? 'checked' : ''; const dbOptimizedChecked = databaseConfig === 'optimized' ? 'checked' : ''; %>
      <form method="post" action="/settings/install/database">
        <label style="margin-right:1rem;"><input type="radio" name="choice" value="mysql" checked> MySQL 8</label>
        <label><input type="radio" name="choice" value="mariadb"> MariaDB 10</label>
        <div style="margin-top:0.5rem;">
          <label style="margin-right:0.75rem;"><input type="radio" name="database_config" value="default" <%= dbDefaultChecked %>> Default</label>
          <label><input type="radio" name="database_config" value="optimized" <%= dbOptimizedChecked %>> Optimized</label>
        </div>
        <button type="submit" style="margin-top:0.5rem;">Install database</button>
      </form>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">Mail (Postfix + Dovecot)</h3>
      <% if (hasMail) { %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed.</p>
      <% } else { %>
      <form method="post" action="/settings/install/mail">
        <button type="submit">Install Mail</button>
      </form>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">FTP (ProFTPD)</h3>
      <% if (hasFtp) { %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed.</p>
      <% } else { %>
      <form method="post" action="/settings/install/ftp">
        <button type="submit">Install FTP</button>
      </form>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.5rem 0; font-size:1rem;">Certbot (Let's Encrypt)</h3>
      <% if (hasCertbot) { %>
      <p style="margin:0; font-size:0.9rem; color:#52796f;">Installed.</p>
      <% } else { %>
      <form method="post" action="/settings/install/certbot">
        <button type="submit">Install Certbot</button>
      </form>
      <% } %>
    </div>

    <p style="margin-top:1.5rem; font-size:0.9rem; color:#52796f;"><% const _w = state && state.completed ? 'Yes' : 'No'; const _c = state && state.certbot_installed ? 'Yes' : 'No'; %>Wizard completed: <%= _w %> · Certbot installed: <%= _c %></p>
    </div>
  </main>
  <script>
  (function() {
    var TAB_IDS = ["paths", "services", "components"];
    function getTabFromHash() {
      var hash = (window.location.hash || "").replace(/^#/, "");
      return TAB_IDS.indexOf(hash) >= 0 ? hash : "paths";
    }
    function switchTab(id) {
      TAB_IDS.forEach(function(tabId) {
        var panel = document.getElementById("panel-" + tabId);
        var trigger = document.getElementById("tab-" + tabId);
        if (panel) panel.classList.toggle("is-active", tabId === id);
        if (trigger) trigger.classList.toggle("is-active", tabId === id);
      });
      window.location.hash = id;
    }
    document.addEventListener("click", function(e) {
      var trigger = e.target.closest(".tabs-trigger");
      if (trigger && trigger.dataset.tab) {
        e.preventDefault();
        switchTab(trigger.dataset.tab);
      }
    });
    window.addEventListener("hashchange", function() { switchTab(getTabFromHash()); });
    switchTab(getTabFromHash());

    (function serviceRestart() {
      var forms = document.querySelectorAll(".js-service-restart-form");
      forms.forEach(function(form) {
        form.addEventListener("submit", function(e) {
          e.preventDefault();
          var row = form.closest("tr");
          var unit = row && row.dataset.serviceUnit;
          var btn = form.querySelector(".js-restart-btn");
          var feedback = row && row.querySelector(".js-service-feedback");
          var statusCell = row && row.querySelector(".service-status");
          if (!row || !btn || !feedback) return;
          var origText = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Restarting…";
          feedback.className = "service-feedback loading js-service-feedback";
          feedback.textContent = "Restarting service…";
          feedback.setAttribute("role", "status");

          var serviceInput = form.querySelector('input[name="service"]');
          var serviceValue = (serviceInput && serviceInput.value) || (row && row.dataset.serviceUnit) || "";
          var body = "service=" + encodeURIComponent(serviceValue);
          fetch(form.action, {
            method: "POST",
            body: body,
            headers: { "Accept": "application/json", "Content-Type": "application/x-www-form-urlencoded" }
          })
            .then(function(r) {
              var contentType = r.headers.get("Content-Type") || "";
              if (contentType.indexOf("application/json") !== -1) return r.json();
              throw new Error("Server did not return JSON");
            })
            .then(function(data) {
              if (data.ok) {
                feedback.className = "service-feedback success js-service-feedback";
                feedback.textContent = "Restarted";
                if (statusCell) {
                  statusCell.textContent = (data.status === "active") ? "Running" : (data.status || "Unknown");
                  statusCell.className = "service-status " + (data.status === "active" ? "status-active" : "status-inactive");
                }
                setTimeout(function() {
                  feedback.textContent = "";
                  feedback.className = "service-feedback js-service-feedback";
                  btn.disabled = false;
                  btn.textContent = origText;
                }, 2500);
              } else {
                feedback.className = "service-feedback error js-service-feedback";
                feedback.textContent = data.message || "Restart failed";
                btn.disabled = false;
                btn.textContent = origText;
              }
            })
            .catch(function(err) {
              feedback.className = "service-feedback error js-service-feedback";
              feedback.textContent = err.message || "Request failed";
              btn.disabled = false;
              btn.textContent = origText;
            });
        });
      });
    })();
  })();
  </script>
</body>
</html>
