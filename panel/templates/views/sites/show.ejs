<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= site.domain %> – Tinchost Panel</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #eef5ef; color: #1b4332; }
    .nav { background: #2d6a4f; color: #fff; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .nav a { color: #d8f3dc; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; }
    .nav a:hover { color: #fff; }
    .nav .nav-right { margin-left: auto; }
    .ic { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .nav .ic { width: 18px; height: 18px; flex-shrink: 0; }
    .nav .nav-active { color: #fff; font-weight: 600; }
    main { max-width: 960px; margin: 0 auto; padding: 1.5rem; background: #fff; min-height: 80vh; border: 1px solid #b7d4bc; border-top: none; }
    h1 { margin-top: 0; color: #1b4332; font-size: 1.5rem; }
    .breadcrumb { margin-bottom: 1rem; }
    .breadcrumb a { color: #2d6a4f; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .card { border: 1px solid #b7d4bc; border-radius: 6px; padding: 1.25rem; margin-bottom: 1.25rem; background: #fff; }
    .card h2 { margin: 0 0 0.75rem 0; color: #2d6a4f; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card h2 .ic { width: 20px; height: 20px; }
    .site-meta { display: flex; flex-wrap: wrap; gap: 1rem 2rem; margin: 0.5rem 0; color: #52796f; font-size: 0.95rem; }
    .site-actions { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn { padding: 0.4rem 0.9rem; background: #2d6a4f; color: #fff; text-decoration: none; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.35rem; }
    .btn:hover { background: #1b4332; color: #fff; }
    .btn-secondary { background: #52796f; }
    .btn-secondary:hover { background: #354f52; }
    .btn-danger { background: #9b2226; }
    .btn-danger:hover { background: #7a1c1e; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #e8f5e9; }
    th { color: #2d6a4f; font-weight: 600; font-size: 0.875rem; }
    .form-row { margin-bottom: 0.75rem; }
    .form-row label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #1b4332; }
    .form-row input { padding: 0.4rem 0.5rem; border: 1px solid #b7d4bc; border-radius: 4px; width: 100%; max-width: 240px; }
    .form-row .hint { font-size: 0.85rem; color: #52796f; margin-top: 0.25rem; display: block; }
    .form-inline { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-end; margin-top: 0.75rem; }
    .error-msg { background: #f8d7da; border: 1px solid #9b2226; color: #9b2226; padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; }
    .success-msg { background: #d8f3dc; border: 1px solid #2d6a4f; color: #1b4332; padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; }
    .empty-msg { color: #52796f; font-size: 0.9rem; }
    form.inline { display: inline; }
    .credential-box { background: #d8f3dc; border: 1px solid #2d6a4f; color: #1b4332; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .credential-box strong { display: block; margin-bottom: 0.35rem; }
    .credential-box .password { font-family: monospace; user-select: all; }
    .btn-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    .password-cell { display: flex; flex-wrap: wrap; align-items: center; gap: 0.35rem; }
    .password-cell .show-hint { font-size: 0.8rem; color: #52796f; }
    .password-cell .pwd-value { font-family: monospace; user-select: all; }
    .tabs { margin: 0 0 0 0; border-bottom: 1px solid #b7d4bc; }
    .tabs-list { display: flex; flex-wrap: wrap; gap: 0; list-style: none; margin: 0; padding: 0; }
    .tabs-list li { margin: 0; }
    .tabs-trigger { padding: 0.75rem 1rem; color: #52796f; text-decoration: none; border-bottom: 3px solid transparent; margin-bottom: -1px; display: flex; align-items: center; gap: 0.4rem; font-size: 0.95rem; }
    .tabs-trigger:hover { color: #2d6a4f; }
    .tabs-trigger.is-active { color: #2d6a4f; font-weight: 600; border-bottom-color: #2d6a4f; }
    .tabs-trigger .ic { width: 18px; height: 18px; }
    .tabs-panel { display: none; padding-top: 1.25rem; }
    .tabs-panel.is-active { display: block; }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="/"><svg class="ic" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Dashboard</a>
    <a href="/sites" class="nav-active"><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>Sites</a>
    <a href="/databases"><svg class="ic" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>Databases</a>
    <a href="/mail"><svg class="ic" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Mail</a>
    <a href="/settings"><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a>
    <span class="nav-right"><% if (typeof user !== "undefined" && user) { %><%= user.username %> · <% } %><a href="/auth/logout"><svg class="ic" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Logout</a></span>
  </nav>
  <main>
    <div class="breadcrumb"><a href="/">Dashboard</a> → <a href="/sites">Sites</a> → <strong><%= site.domain %></strong></div>
    <h1><%= site.domain %></h1>

    <% if (typeof error !== "undefined" && error) { %>
    <div class="error-msg"><%= error %><% if (typeof panelDbPath !== "undefined" && panelDbPath) { %> <br><br>Panel database path: <code style="font-size:0.85em; word-break:break-all;"><%= panelDbPath %></code><% } %></div>
    <% } %>
    <% if (typeof reset !== "undefined" && reset === "ftp") { %>
    <div class="success-msg">FTP password updated. Use the new password and the <strong>FTP login</strong> name below to connect.</div>
    <% } %>
    <% if (typeof reset !== "undefined" && reset === "db") { %>
    <div class="success-msg">Database user password updated. Use the new password to connect to MySQL.</div>
    <% } %>
    <% if (typeof renew !== "undefined" && renew === "ok") { %>
    <div class="success-msg">SSL certificate renewed successfully.</div>
    <% } %>
    <% if (typeof renew !== "undefined" && renew === "error") { %>
    <div class="error-msg">SSL renewal failed. Check that DNS points to this server and ports 80/443 are open, then try again.</div>
    <% } %>
    <% if (typeof sslRemoved !== "undefined" && sslRemoved) { %>
    <div class="success-msg">SSL certificate removed. The site now serves over HTTP only. Re-enable SSL in Edit settings if needed.</div>
    <% } %>
    <% if (typeof phpOptionsSaved !== "undefined" && phpOptionsSaved) { %>
    <div class="success-msg">PHP options saved. They apply only to this site.</div>
    <% } %>

    <nav class="tabs" aria-label="Site sections">
      <ul class="tabs-list">
        <li><a href="#overview" class="tabs-trigger is-active" data-tab="overview" id="tab-overview"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>Overview</a></li>
        <li><a href="#databases" class="tabs-trigger" data-tab="databases" id="tab-databases"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>Databases</a></li>
        <li><a href="#ftp" class="tabs-trigger" data-tab="ftp" id="tab-ftp"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>FTP</a></li>
        <li><a href="#ssl" class="tabs-trigger" data-tab="ssl" id="tab-ssl"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>SSL</a></li>
        <% if (site.app_type !== 'node') { %><li><a href="#php" class="tabs-trigger" data-tab="php" id="tab-php"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M16 18l6-6-6-6"/><path d="M8 6l-6 6 6 6"/></svg>PHP</a></li><% } %>
        <li><a href="#scripts" class="tabs-trigger" data-tab="scripts" id="tab-scripts"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Scripts</a></li>
        <% if (site.app_type === 'node') { %><li><a href="#node-apps" class="tabs-trigger" data-tab="node-apps" id="tab-node-apps"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L22 8v8l-10 6L2 16V8l10-6z"/></svg>My Node apps</a></li><% } %>
        <li><a href="/sites/<%= site.id %>/files" class="tabs-trigger"><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>File Manager</a></li>
      </ul>
    </nav>

    <div id="panel-overview" class="tabs-panel is-active" role="tabpanel" aria-labelledby="tab-overview">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>Site settings</h2>
      <div class="site-meta">
        <span><strong>Docroot</strong> <%= site.docroot %></span>
        <span><strong>App</strong> <%= (site.app_type === 'node') ? ('Node :' + (site.node_port || '')) : ('PHP ' + (site.php_version || '-')) %></span>
        <span><strong>SSL</strong> <%= site.ssl ? "Yes" : "No" %></span>
        <span><strong>FTP</strong> <%= site.ftp_enabled ? "Enabled" : "Off" %></span>
        <span><strong>Space utilized</strong> <%= (typeof docrootSizeFormatted !== "undefined" && docrootSizeFormatted) ? docrootSizeFormatted : "—" %></span>
      </div>
      <% const _dbCount = (typeof siteDatabases !== "undefined" && siteDatabases) ? siteDatabases.length : 0; const _ftpCount = (typeof ftpUsers !== "undefined" && ftpUsers) ? ftpUsers.length : 0; const _scriptsCount = (typeof installedScripts !== "undefined" && installedScripts) ? installedScripts.length : 0; %>
      <p class="overview-summary" style="font-size:0.9rem; color:#52796f; margin:0.75rem 0 0 0;">
        <a href="#databases">Databases</a>: <%= _dbCount %> · <a href="#ftp">FTP users</a>: <%= _ftpCount %> · <a href="#scripts">Scripts</a>: <%= _scriptsCount %><% if (site.app_type === 'node') { %> · <a href="#node-apps">My Node apps</a><% } %>
      </p>
      <div class="site-actions">
        <a href="/sites/<%= site.id %>/edit" class="btn">Edit settings</a>
        <form method="post" action="/sites/<%= site.id %>/delete" class="inline" data-confirm="Delete this site? Nginx vhost and site-specific databases/FTP users will be removed. This cannot be undone.">
          <button type="submit" class="btn btn-danger">Delete site</button>
        </form>
      </div>
    </div>
    </div>

    <% if (site.app_type === 'node') { %>
    <div id="panel-node-apps" class="tabs-panel" role="tabpanel" aria-labelledby="tab-node-apps">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22"/></svg>Clone repository</h2>
      <p style="font-size:0.9rem; color:#52796f; margin:0 0 1rem 0;">Clone a Git repository into the site docroot. Use the docroot path to put the app at the root, or a subfolder (e.g. <code>app</code>) to clone into a subdirectory.</p>
      <% if (typeof cloneOk !== 'undefined' && cloneOk) { %>
      <div class="success-msg">Repository cloned successfully. Install dependencies and start the app below.</div>
      <% } %>
      <% if (typeof cloneError !== 'undefined' && cloneError) { %>
      <div class="error-msg"><%= cloneError %></div>
      <% } %>
      <form method="post" action="/sites/<%= site.id %>/clone" style="margin-top:0.5rem;">
        <div class="form-row">
          <label for="clone_repo_url">Repository URL</label>
          <input type="text" id="clone_repo_url" name="repo_url" required placeholder="https://github.com/user/repo.git or git@github.com:user/repo.git">
        </div>
        <div class="form-row">
          <label for="clone_branch">Branch (optional)</label>
          <input type="text" id="clone_branch" name="branch" placeholder="main">
        </div>
        <div class="form-row">
          <label for="clone_target">Subfolder (optional)</label>
          <input type="text" id="clone_target" name="target" placeholder="Leave empty for docroot; or e.g. app">
          <span class="hint">Empty = clone into docroot (docroot must be empty). Otherwise the repo is cloned into this subfolder.</span>
        </div>
        <button type="submit" class="btn">Clone repository</button>
      </form>
    </div>
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M12 2L22 8v8l-10 6L2 16V8l10-6z"/></svg>Node app</h2>
      <p style="font-size:0.9rem; color:#52796f; margin:0 0 1rem 0;">Install dependencies, set environment variables, and start or restart your app. No shell access needed — everything runs from this panel. The app must listen on port <strong><%= site.node_port || '' %></strong>. Your <code>package.json</code> should have a <code>start</code> script (e.g. <code>\"start\": \"node server.js\"</code>).</p>
      <div class="form-row">
        <label for="node_app_subfolder">App subfolder (optional)</label>
        <input type="text" id="node_app_subfolder" placeholder="e.g. app (if you cloned into a subfolder)" value="<%= (typeof currentEnvSubfolder !== 'undefined' && currentEnvSubfolder) ? currentEnvSubfolder : '' %>">
        <span class="hint">Leave empty if your app is in the docroot. Use the same value for install, .env, and start.</span>
      </div>
      <% if (typeof npmOk !== 'undefined' && npmOk) { %><div class="success-msg">Dependencies installed successfully.</div><% } %>
      <% if (typeof npmError !== 'undefined' && npmError) { %><div class="error-msg"><%= npmError %></div><% } %>
      <form method="post" action="/sites/<%= site.id %>/npm-install" class="form-inline">
        <input type="hidden" name="subfolder" id="npm_subfolder">
        <button type="submit" class="btn">Run npm install</button>
      </form>
      <p style="font-size:0.9rem; color:#52796f; margin:1rem 0 0.5rem 0;"><strong>Environment (.env)</strong> — Set <code>PORT=<%= site.node_port || '' %></code> and other variables. Save to docroot or the subfolder above.</p>
      <% if (typeof envOk !== 'undefined' && envOk) { %><div class="success-msg">.env saved.</div><% } %>
      <% if (typeof envError !== 'undefined' && envError) { %><div class="error-msg"><%= envError %></div><% } %>
      <form method="post" action="/sites/<%= site.id %>/env" style="margin-top:0.5rem;">
        <input type="hidden" name="subfolder" id="env_subfolder">
        <div class="form-row">
          <label for="env_content">.env contents</label>
          <textarea name="env_content" id="env_content" rows="6" style="width:100%; max-width:480px; font-family:monospace; font-size:0.85rem; padding:0.5rem; border:1px solid #b7d4bc; border-radius:4px;"><%= (typeof envContent !== 'undefined' && envContent) ? String(envContent).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '' %></textarea>
        </div>
        <button type="submit" class="btn">Save .env</button>
        <% if (typeof currentEnvSubfolder !== 'undefined' && currentEnvSubfolder) { %><a href="/sites/<%= site.id %>#node-apps" class="btn btn-secondary" style="margin-left:0.35rem;">Show docroot .env</a><% } %>
      </form>
      <form method="get" action="/sites/<%= site.id %>#node-apps" class="inline" style="margin-left:0; margin-top:0.5rem;"><input type="hidden" name="env_subfolder" id="load_env_subfolder"><button type="submit" class="btn btn-secondary">Load .env from subfolder</button></form>
      <p style="font-size:0.9rem; color:#52796f; margin:1.25rem 0 0.5rem 0;"><strong>Apps running (PM2)</strong></p>
      <% if (typeof nodeStarted !== 'undefined' && nodeStarted) { %><div class="success-msg">App started. It should be available at your site URL.</div><% } %>
      <% if (typeof nodeRestarted !== 'undefined' && nodeRestarted) { %><div class="success-msg">App restarted.</div><% } %>
      <% if (typeof nodeStopped !== 'undefined' && nodeStopped) { %><div class="success-msg">App stopped.</div><% } %>
      <% if (typeof nodeDeleted !== 'undefined' && nodeDeleted) { %><div class="success-msg">App removed from PM2. You can start it again from this panel when needed.</div><% } %>
      <% if (typeof nodeError !== 'undefined' && nodeError) { %><div class="error-msg"><%= nodeError %></div><% } %>
      <p style="font-size:0.85rem; color:#52796f; margin:0.25rem 0 0.5rem 0;">
        <% if (typeof nodePm2Name !== 'undefined' && nodePm2Name) { %><span style="font-weight:600;"><%= nodePm2Name %></span> — <% } %>
        <% if (typeof nodePm2Status !== 'undefined' && nodePm2Status === 'running') { %><span style="color:#2d6a4f; font-weight:600;">Running</span><% } else if (nodePm2Status === 'stopped') { %><span style="color:#9b2226;">Stopped</span><% } else { %><span>Not in PM2</span><% } %>
      </p>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem;">
        <% if (typeof nodePm2Status !== 'undefined' && nodePm2Status === 'running') { %>
        <form method="post" action="/sites/<%= site.id %>/node-restart" class="inline">
          <button type="submit" class="btn">Restart app</button>
        </form>
        <form method="post" action="/sites/<%= site.id %>/node-stop" class="inline">
          <button type="submit" class="btn btn-secondary">Stop app</button>
        </form>
        <% } else if (nodePm2Status !== 'running') { %>
        <form method="post" action="/sites/<%= site.id %>/node-start" class="inline">
          <input type="hidden" name="subfolder" id="start_subfolder">
          <button type="submit" class="btn">Start app</button>
        </form>
        <% } %>
        <% if (typeof nodePm2Status !== 'undefined' && (nodePm2Status === 'running' || nodePm2Status === 'stopped')) { %>
        <form method="post" action="/sites/<%= site.id %>/node-delete" class="inline" data-confirm="Remove this app from PM2 completely? The process will be deleted. You can start it again later from this panel.">
          <button type="submit" class="btn btn-secondary">Delete app</button>
        </form>
        <% } %>
        <a href="/sites/<%= site.id %>/node-logs" target="_blank" rel="noopener" class="btn btn-secondary">View logs</a>
      </div>
    </div>
    </div>
    <% } %>

    <div id="panel-databases" class="tabs-panel" role="tabpanel" aria-labelledby="tab-databases">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>Databases for this site</h2>
      <% if (!hasMysqlPassword) { %>
      <p class="empty-msg">Set the MySQL root password in <a href="/settings">Settings</a> to create databases from the panel.</p>
      <% } else { %>
      <% if (typeof newDbCredentials !== "undefined" && newDbCredentials) { %>
      <div class="credential-box">
        <strong>New user created — save these credentials (shown once)</strong>
        Database: <strong><%= newDbCredentials.database %></strong> · User: <strong><%= newDbCredentials.username %></strong> · Password: <span class="password"><%= newDbCredentials.password %></span>
        <button type="button" class="btn btn-small btn-secondary js-copy-password">Copy password</button>
      </div>
      <% } %>
      <% if (siteDatabases.length) { %>
      <table>
        <thead><tr><th>Database</th><th>Size</th><th>User</th><th>Privileges</th><th>Password</th><th></th></tr></thead>
        <tbody>
          <% siteDatabases.forEach(function(d) {
            const grants = (typeof databaseGrants !== "undefined" ? databaseGrants : []).filter(function(g) { return g.database_id === d.id; });
            const sizeStr = (typeof databaseSizes !== "undefined" && databaseSizes[d.name]) ? databaseSizes[d.name] : "—";
          %>
          <% if (grants.length) { %>
            <% grants.forEach(function(g, gIdx) { %>
          <tr>
            <td><%= d.name %></td>
            <td><%= gIdx === 0 ? sizeStr : "" %></td>
            <td><%= g.username %></td>
            <td><%= (g.privileges || "ALL").split("_").join(" ") %></td>
            <td class="password-cell">
              <span class="pwd-mask">••••••</span>
              <button type="button" class="btn btn-small btn-secondary show-pwd-btn">Show</button>
              <% if (g.password_plain) { %><span class="pwd-value" style="display:none;"><%= g.password_plain %></span><% } else { %><span class="show-hint" style="display:none;">Not stored — use Reset</span><% } %>
              <form method="post" action="/sites/<%= site.id %>/db-users/<%= g.db_user_id %>/reset-password" class="inline">
                <input type="password" name="password" placeholder="New password" required style="max-width:10rem;">
                <button type="submit" class="btn btn-small">Reset</button>
              </form>
            </td>
            <td>
              <% if (gIdx === 0) { %>
              <form method="post" action="/sites/<%= site.id %>/databases/<%= d.id %>/delete" class="inline" data-confirm="Delete database <%= d.name %>? This will DROP the database in MySQL. Cannot be undone.">
                <button type="submit" class="btn btn-danger">Delete DB</button>
              </form>
              <% } %>
            </td>
          </tr>
            <% }); %>
          <% } else { %>
          <tr>
            <td><%= d.name %></td>
            <td><%= sizeStr %></td>
            <td>—</td>
            <td>—</td>
            <td>—</td>
            <td>
              <form method="post" action="/sites/<%= site.id %>/databases/<%= d.id %>/delete" class="inline" data-confirm="Delete database <%= d.name %>? This will DROP the database in MySQL. Cannot be undone.">
                <button type="submit" class="btn btn-danger">Delete DB</button>
              </form>
            </td>
          </tr>
          <% } %>
          <% }); %>
        </tbody>
      </table>
      <% } else { %>
      <p class="empty-msg">No databases yet for this site.</p>
      <% } %>
      <form method="post" action="/sites/<%= site.id %>/databases" style="margin-top:1rem;">
        <div class="form-row">
          <label>Database name</label>
          <input type="text" name="name" required pattern="[a-zA-Z0-9_]+" title="Letters, numbers, underscore only">
        </div>
        <div class="form-row">
          <label>Assign user</label>
          <select name="assign_user" id="assign_user">
            <option value="">— None —</option>
            <option value="new">— New user —</option>
            <% (typeof existingDbUsers !== "undefined" ? existingDbUsers : []).forEach(function(u) { %>
            <option value="<%= u.id %>"><%= u.username %></option>
            <% }); %>
          </select>
        </div>
        <div class="form-row" id="row-new-user" style="display:none;">
          <label>New username</label>
          <input type="text" name="db_username" placeholder="Username for DB access" pattern="[a-zA-Z0-9_]+" title="Letters, numbers, underscore only">
        </div>
        <div class="form-row" id="row-new-password" style="display:none;">
          <label>Password (required for new user)</label>
          <input type="password" name="db_password" placeholder="User password">
        </div>
        <div class="form-row">
          <label>Privileges</label>
          <select name="privileges">
            <% (typeof privilegeOptions !== "undefined" ? privilegeOptions : ["ALL","READ_WRITE","READ_ONLY"]).forEach(function(p) { %>
            <option value="<%= p %>" <%= p === "ALL" ? "selected" : "" %>><%= p === "ALL" ? "All" : (p === "READ_WRITE" ? "Read / Write" : "Read only") %></option>
            <% }); %>
          </select>
        </div>
        <button type="submit" class="btn">Add database</button>
      </form>
      <% } %>
    </div>
    </div>

    <div id="panel-ftp" class="tabs-panel" role="tabpanel" aria-labelledby="tab-ftp">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>FTP users for this site</h2>
      <% if (!site.ftp_enabled) { %>
      <p class="empty-msg">Enable FTP for this site in <a href="/sites/<%= site.id %>/edit">Edit settings</a> to add FTP users.</p>
      <% } else { %>
      <% if (typeof newFtpCredentials !== "undefined" && newFtpCredentials) {
        const newFtpLogin = (typeof site !== "undefined" && site.domain) ? (newFtpCredentials.username + "@" + site.domain) : newFtpCredentials.username;
      %>
      <div class="credential-box">
        <strong>New FTP user created — save these credentials (shown once)</strong>
        Use <strong>FTP login</strong> in your client: <code><%= newFtpLogin %></code> · Password: <span class="password"><%= newFtpCredentials.password %></span>
        <button type="button" class="btn btn-small btn-secondary js-copy-password">Copy password</button>
      </div>
      <% } %>
      <p class="empty-msg">Use the <strong>FTP login</strong> (name@domain) in your FTP client, e.g. <code>martin@example.com</code>.</p>
      <% if (ftpUsers.length) { %>
      <table>
        <thead><tr><th>Name</th><th>FTP login</th><th>Default route</th><th>Password</th><th></th></tr></thead>
        <tbody>
          <% ftpUsers.forEach(function(u) {
            const ftpLogin = (typeof site !== "undefined" && site.domain) ? (u.username + "@" + site.domain) : u.username;
          %>
          <tr>
            <td><%= u.username %></td>
            <td><code><%= ftpLogin %></code></td>
            <td><%= (u.default_route && u.default_route !== "") ? u.default_route : "(docroot)" %></td>
            <td class="password-cell">
              <% if (!u.crypt_hash || u.crypt_hash === "") { %>
              <span class="show-hint">FTP login disabled — set password below to enable.</span>
              <% } else { %>
              <span class="pwd-mask">••••••</span>
              <button type="button" class="btn btn-small btn-secondary show-pwd-btn">Show</button>
              <% if (u.password_plain) { %><span class="pwd-value" style="display:none;"><%= u.password_plain %></span><% } else { %><span class="show-hint" style="display:none;">Not stored — use Reset</span><% } %>
              <form method="post" action="/sites/<%= site.id %>/ftp-users/<%= u.id %>/reset-password" class="inline">
                <input type="password" name="password" placeholder="New password" required style="max-width:10rem;" autocomplete="new-password">
                <button type="submit" class="btn btn-small">Reset</button>
              </form>
            </td>
            <td>
              <form method="post" action="/sites/<%= site.id %>/ftp-users/<%= u.id %>/delete" class="inline" data-confirm="Remove FTP user <%= u.username %>?">
                <button type="submit" class="btn btn-danger">Remove</button>
              </form>
            </td>
          </tr>
          <% } %><% }); %>
        </tbody>
      </table>
      <% } else { %>
      <p class="empty-msg">No FTP users yet. Add one below; set the default route to restrict access to a subdirectory (e.g. / or /public).</p>
      <% } %>
      <form method="post" action="/sites/<%= site.id %>/ftp-users" style="margin-top:1rem;">
        <div class="form-row">
          <label>Name</label>
          <input type="text" name="username" required placeholder="e.g. martin (FTP login will be name@<%= site.domain %>)">
        </div>
        <div class="form-row">
          <label>Password</label>
          <input type="password" name="password" required>
        </div>
        <div class="form-row">
          <label>Default route</label>
          <input type="text" name="default_route" placeholder="e.g. / or /public (blank = site docroot)">
        </div>
        <button type="submit" class="btn">Add FTP user</button>
      </form>
      <% } %>
    </div>
    </div>

    <div id="panel-ssl" class="tabs-panel" role="tabpanel" aria-labelledby="tab-ssl">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>SSL certificate</h2>
      <% if (typeof sslError === "string" && sslError) { %>
      <div class="error-msg">SSL remove failed: <%= sslError %></div>
      <% } %>
      <% if (site.ssl) { %>
        <% if (typeof sslStatus !== "undefined" && sslStatus && sslStatus.found) { %>
        <div class="site-meta">
          <span><strong>Status</strong> <%= (sslStatus.valid === true) ? "Valid" : (sslStatus.valid === false ? "Expired" : "Unknown") %></span>
          <% if (sslStatus.expiry) { %><span><strong>Expires</strong> <%= sslStatus.expiry %></span><% } %>
          <% if (typeof sslStatus.daysLeft === "number") { %><span><strong>Days left</strong> <%= sslStatus.daysLeft %></span><% } %>
        </div>
        <div class="site-actions">
          <form method="post" action="/sites/<%= site.id %>/ssl/renew" class="inline">
            <button type="submit" class="btn">Renew certificate</button>
          </form>
          <form method="post" action="/sites/<%= site.id %>/ssl/delete" class="inline" data-confirm="Remove SSL for <%= site.domain %>? The site will serve over HTTP only. You can re-enable SSL in Edit settings later.">
            <button type="submit" class="btn btn-danger">Remove SSL</button>
          </form>
        </div>
        <p class="empty-msg">Renew before expiry to avoid interruption. Removing SSL deletes the Let's Encrypt certificate and switches the site to HTTP.</p>
        <% } else { %>
        <p class="empty-msg">Certificate is enabled but status could not be read (certificate path may be missing or not accessible).</p>
        <div class="site-actions">
          <form method="post" action="/sites/<%= site.id %>/ssl/renew" class="inline">
            <button type="submit" class="btn">Renew certificate</button>
          </form>
          <form method="post" action="/sites/<%= site.id %>/ssl/delete" class="inline" data-confirm="Remove SSL for <%= site.domain %>? The site will serve over HTTP only.">
            <button type="submit" class="btn btn-danger">Remove SSL</button>
          </form>
        </div>
        <% } %>
      <% } else { %>
        <p class="empty-msg">SSL is off for this site. Enable it in <a href="/sites/<%= site.id %>/edit">Edit settings</a> to get a Let's Encrypt certificate.</p>
      <% } %>
    </div>
    </div>

    <div id="panel-php" class="tabs-panel" role="tabpanel" aria-labelledby="tab-php">
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6"/><path d="M8 6l-6 6 6 6"/></svg>PHP options</h2>
      <% if (site.app_type === 'node') { %>
      <p class="empty-msg">This site runs Node. PHP options do not apply.</p>
      <% } else { %>
      <p class="empty-msg">Override PHP settings for this site only. Leave a field empty to use the server default.</p>
      <% 
        let phpOpts = {};
        if (typeof site.php_options === "string" && site.php_options) {
          try { phpOpts = JSON.parse(site.php_options); } catch (_) {}
        }
        const commonPhpKeys = ["memory_limit", "upload_max_filesize", "max_execution_time", "post_max_size", "max_input_vars"];
        const extraPhpLines = typeof phpOpts === "object" && phpOpts !== null
          ? Object.keys(phpOpts).filter(function(k) { return commonPhpKeys.indexOf(k) < 0; }).map(function(k) { return k + "=" + (phpOpts[k] || ""); })
          : [];
      %>
      <form method="post" action="/sites/<%= site.id %>/php-options" style="margin-top:1rem;">
        <div class="form-row">
          <label for="php-memory_limit">memory_limit</label>
          <input type="text" id="php-memory_limit" name="memory_limit" value="<%= (phpOpts.memory_limit || "") %>" placeholder="e.g. 256M">
        </div>
        <div class="form-row">
          <label for="php-upload_max_filesize">upload_max_filesize</label>
          <input type="text" id="php-upload_max_filesize" name="upload_max_filesize" value="<%= (phpOpts.upload_max_filesize || "") %>" placeholder="e.g. 64M">
        </div>
        <div class="form-row">
          <label for="php-max_execution_time">max_execution_time</label>
          <input type="text" id="php-max_execution_time" name="max_execution_time" value="<%= (phpOpts.max_execution_time || "") %>" placeholder="e.g. 300">
        </div>
        <div class="form-row">
          <label for="php-post_max_size">post_max_size</label>
          <input type="text" id="php-post_max_size" name="post_max_size" value="<%= (phpOpts.post_max_size || "") %>" placeholder="e.g. 64M">
        </div>
        <div class="form-row">
          <label for="php-max_input_vars">max_input_vars</label>
          <input type="text" id="php-max_input_vars" name="max_input_vars" value="<%= (phpOpts.max_input_vars || "") %>" placeholder="e.g. 3000">
        </div>
        <div class="form-row">
          <label for="php-extra_options">Additional options (one per line: key=value)</label>
          <textarea id="php-extra_options" name="extra_options" rows="4" placeholder="e.g.&#10;display_errors=Off&#10;date.timezone=Europe/Madrid"><%= extraPhpLines.join("\n") %></textarea>
        </div>
        <button type="submit" class="btn">Save PHP options</button>
      </form>
      <% } %>
    </div>
    </div>

    <div id="panel-scripts" class="tabs-panel" role="tabpanel" aria-labelledby="tab-scripts">
    <% const _scheme = site.ssl ? "https" : "http"; const _baseUrl = _scheme + "://" + site.domain; %>
    <% if (typeof scriptUninstallOk !== 'undefined' && scriptUninstallOk) { %><div class="success-msg">Script uninstalled. Files have been removed.</div><% } %>
    <% if (typeof scriptUninstallError !== 'undefined' && scriptUninstallError) { %><div class="error-msg"><%= scriptUninstallError %></div><% } %>
    <% if (typeof installedScripts !== "undefined" && installedScripts && installedScripts.length > 0) { %>
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Installed scripts</h2>
      <p style="font-size:0.9rem; color:#52796f; margin:0 0 1rem 0;">Scripts detected in this site’s docroot. Use the links below to open the site or admin. You can uninstall to remove the script files.</p>
      <ul class="script-list" style="list-style:none; margin:0; padding:0;">
        <% installedScripts.forEach(function(script) {
          const openUrl = _baseUrl + (script.urlPath || '/');
          const adminUrl = script.adminPath ? (_baseUrl + script.adminPath) : null;
          const locationLabel = script.subfolder ? '/' + script.subfolder : 'site root';
        %>
        <li class="script-item" style="border:1px solid #b7d4bc; border-radius:6px; padding:1rem; margin-bottom:0.75rem; background:#f8fcf9;">
          <div style="display:flex; align-items:center; flex-wrap:wrap; gap:0.5rem 1rem;">
            <strong><%= script.name %></strong>
            <% if (script.version) { %><span style="font-size:0.85rem; color:#52796f;">Version <%= script.version %></span><% } %>
            <span style="font-size:0.85rem; color:#52796f;">Location: <%= locationLabel %></span>
          </div>
          <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center;">
            <a href="<%= openUrl %>" target="_blank" rel="noopener" class="btn" style="padding:0.35rem 0.7rem; font-size:0.85rem;">Open site</a>
            <% if (adminUrl) { %><a href="<%= adminUrl %>" target="_blank" rel="noopener" class="btn" style="padding:0.35rem 0.7rem; font-size:0.85rem;">WordPress admin</a><% } %>
            <% if (script.id === 'wordpress') { %>
              <% if (script.subfolder) { %>
            <form method="post" action="/sites/<%= site.id %>/scripts/uninstall" class="inline" data-confirm="Uninstall <%= script.name %> from /<%= script.subfolder %>? All files in this folder will be permanently deleted. The database is not removed.">
              <input type="hidden" name="script_id" value="wordpress">
              <input type="hidden" name="subfolder" value="<%= script.subfolder %>">
              <button type="submit" class="btn btn-danger" style="padding:0.35rem 0.7rem; font-size:0.85rem;">Uninstall</button>
            </form>
              <% } else { %>
            <span style="font-size:0.85rem; color:#52796f;">Uninstall from site root: use <a href="/sites/<%= site.id %>/files">File Manager</a> to remove files.</span>
              <% } %>
            <% } %>
          </div>
        </li>
        <% }); %>
      </ul>
    </div>
    <% } %>
    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>WordPress</h2>
      <p class="empty-msg">WordPress needs a <strong>database</strong> and a <strong>database user</strong>. Create them in the <a href="#databases">Databases</a> tab if you have not already.</p>
      <% if (typeof wordpress !== "undefined" && wordpress === "installed") {
        const setupUrl = _baseUrl + ((typeof wp_folder !== "undefined" && wp_folder) ? "/" + wp_folder + "/" : "/");
      %>
      <div class="success-msg">
        <strong>WordPress installed.</strong> Open <a href="<%= setupUrl %>" target="_blank" rel="noopener"><%= setupUrl %></a> in your browser to finish the setup. You will need the database name, database username, and password (create them in the <a href="#databases">Databases</a> tab if needed).
      </div>
      <% } else if (typeof wordpress !== "undefined" && wordpress === "error") { %>
      <div class="error-msg">Installation failed. Check that the target folder is writable and try again, or choose a different subfolder.</div>
      <% } else { %>
      <form method="post" action="/sites/<%= site.id %>/scripts/wordpress" style="margin-top:1rem;">
        <div class="form-row">
          <label for="wp-folder">Install in subfolder</label>
          <input type="text" id="wp-folder" name="folder" placeholder="e.g. blog or leave empty for site root">
        </div>
        <button type="submit" class="btn">Install WordPress</button>
      </form>
      <% } %>
    </div>
    </div>
  </main>
  <script src="/js/confirm-modal.js"></script>
  <script src="/js/sites-show.js"></script>
  <% if (site.app_type === 'node') { %>
  <script>
  (function() {
    var main = document.getElementById('node_app_subfolder');
    if (!main) return;
    document.querySelectorAll('#panel-node-apps form input[name="subfolder"], #panel-node-apps form input[name="env_subfolder"]').forEach(function(inp) {
      inp.closest('form').addEventListener('submit', function() { inp.value = main.value; });
    });
  })();
  </script>
  <% } %>
</body>
</html>
