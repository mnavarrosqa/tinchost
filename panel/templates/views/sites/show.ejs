<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= site.domain %> – Tinchost Panel</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #eef5ef; color: #1b4332; }
    .nav { background: #2d6a4f; color: #fff; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .nav a { color: #d8f3dc; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; }
    .nav a:hover { color: #fff; }
    .nav .nav-right { margin-left: auto; }
    .ic { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .nav .ic { width: 18px; height: 18px; flex-shrink: 0; }
    .nav .nav-active { color: #fff; font-weight: 600; }
    main { max-width: 960px; margin: 0 auto; padding: 1.5rem; background: #fff; min-height: 80vh; border: 1px solid #b7d4bc; border-top: none; }
    h1 { margin-top: 0; color: #1b4332; font-size: 1.5rem; }
    .breadcrumb { margin-bottom: 1rem; }
    .breadcrumb a { color: #2d6a4f; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .card { border: 1px solid #b7d4bc; border-radius: 6px; padding: 1.25rem; margin-bottom: 1.25rem; background: #fff; }
    .card h2 { margin: 0 0 0.75rem 0; color: #2d6a4f; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card h2 .ic { width: 20px; height: 20px; }
    .site-meta { display: flex; flex-wrap: wrap; gap: 1rem 2rem; margin: 0.5rem 0; color: #52796f; font-size: 0.95rem; }
    .site-actions { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn { padding: 0.4rem 0.9rem; background: #2d6a4f; color: #fff; text-decoration: none; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.35rem; }
    .btn:hover { background: #1b4332; color: #fff; }
    .btn-secondary { background: #52796f; }
    .btn-secondary:hover { background: #354f52; }
    .btn-danger { background: #9b2226; }
    .btn-danger:hover { background: #7a1c1e; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #e8f5e9; }
    th { color: #2d6a4f; font-weight: 600; font-size: 0.875rem; }
    .form-row { margin-bottom: 0.75rem; }
    .form-row label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #1b4332; }
    .form-row input { padding: 0.4rem 0.5rem; border: 1px solid #b7d4bc; border-radius: 4px; width: 100%; max-width: 240px; }
    .form-inline { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-end; margin-top: 0.75rem; }
    .error-msg { background: #f8d7da; border: 1px solid #9b2226; color: #9b2226; padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; }
    .success-msg { background: #d8f3dc; border: 1px solid #2d6a4f; color: #1b4332; padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; }
    .empty-msg { color: #52796f; font-size: 0.9rem; }
    form.inline { display: inline; }
    .credential-box { background: #d8f3dc; border: 1px solid #2d6a4f; color: #1b4332; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .credential-box strong { display: block; margin-bottom: 0.35rem; }
    .credential-box .password { font-family: monospace; user-select: all; }
    .btn-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    .password-cell { display: flex; flex-wrap: wrap; align-items: center; gap: 0.35rem; }
    .password-cell .show-hint { font-size: 0.8rem; color: #52796f; }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="/"><svg class="ic" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Dashboard</a>
    <a href="/sites" class="nav-active"><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>Sites</a>
    <a href="/databases"><svg class="ic" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>Databases</a>
    <a href="/mail"><svg class="ic" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Mail</a>
    <a href="/settings"><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a>
    <span class="nav-right"><% if (typeof user !== 'undefined' && user) { %><%= user.username %> · <% } %><a href="/auth/logout"><svg class="ic" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Logout</a></span>
  </nav>
  <main>
    <div class="breadcrumb"><a href="/sites">Sites</a> → <strong><%= site.domain %></strong></div>
    <h1><%= site.domain %></h1>

    <% if (typeof error !== 'undefined' && error) { %>
    <div class="error-msg"><%= error %><% if (typeof panelDbPath !== 'undefined' && panelDbPath) { %> <br><br>Panel database path: <code style="font-size:0.85em; word-break:break-all;"><%= panelDbPath %></code><% } %></div>
    <% } %>
    <% if (typeof reset !== 'undefined' && reset === 'ftp') { %>
    <div class="success-msg">FTP password updated. Use the new password and the <strong>FTP login</strong> name below to connect.</div>
    <% } %>
    <% if (typeof reset !== 'undefined' && reset === 'db') { %>
    <div class="success-msg">Database user password updated. Use the new password to connect to MySQL.</div>
    <% } %>

    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>Site settings</h2>
      <div class="site-meta">
        <span><strong>Docroot</strong> <%= site.docroot %></span>
        <span><strong>PHP</strong> <%= site.php_version || '-' %></span>
        <span><strong>SSL</strong> <%= site.ssl ? 'Yes' : 'No' %></span>
        <span><strong>FTP</strong> <%= site.ftp_enabled ? 'Enabled' : 'Off' %></span>
      </div>
      <div class="site-actions">
        <a href="/sites/<%= site.id %>/edit" class="btn">Edit settings</a>
        <form method="post" action="/sites/<%= site.id %>/delete" class="inline" onsubmit="return confirm('Delete this site? Nginx vhost and site-specific databases/FTP users will be removed. This cannot be undone.');">
          <button type="submit" class="btn btn-danger">Delete site</button>
        </form>
      </div>
    </div>

    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>Databases for this site</h2>
      <% if (!hasMysqlPassword) { %>
      <p class="empty-msg">Set the MySQL root password in <a href="/settings">Settings</a> to create databases from the panel.</p>
      <% } else { %>
      <% if (typeof newDbCredentials !== 'undefined' && newDbCredentials) { %>
      <div class="credential-box">
        <strong>New user created — save these credentials (shown once)</strong>
        Database: <strong><%= newDbCredentials.database %></strong> · User: <strong><%= newDbCredentials.username %></strong> · Password: <span class="password"><%= newDbCredentials.password %></span>
        <button type="button" class="btn btn-small btn-secondary" onclick="var el=this.closest('.credential-box').querySelector('.password'); if(el && navigator.clipboard){ navigator.clipboard.writeText(el.textContent); this.textContent='Copied'; var t=this; setTimeout(function(){ t.textContent='Copy'; }, 1500); }">Copy password</button>
      </div>
      <% } %>
      <% if (siteDatabases.length) { %>
      <table>
        <thead><tr><th>Database</th><th>User</th><th>Privileges</th><th>Password</th><th></th></tr></thead>
        <tbody>
          <% siteDatabases.forEach(function(d) {
            const grants = (typeof databaseGrants !== 'undefined' ? databaseGrants : []).filter(function(g) { return g.database_id === d.id; });
          %>
          <% if (grants.length) { %>
            <% grants.forEach(function(g, gIdx) { %>
          <tr>
            <td><%= d.name %></td>
            <td><%= g.username %></td>
            <td><%= (g.privileges || 'ALL').replace(/_/g, ' ') %></td>
            <td class="password-cell">
              <span class="pwd-mask">••••••</span>
              <button type="button" class="btn btn-small btn-secondary" onclick="var c=this.closest('.password-cell'); c.querySelector('.pwd-mask').style.display='none'; c.querySelector('.show-hint').style.display='inline'; this.style.display='none';">Show</button>
              <span class="show-hint" style="display:none;">Not stored — use Reset</span>
              <form method="post" action="/sites/<%= site.id %>/db-users/<%= g.db_user_id %>/reset-password" class="inline">
                <input type="password" name="password" placeholder="New password" required style="max-width:10rem;">
                <button type="submit" class="btn btn-small">Reset</button>
              </form>
            </td>
            <td>
              <% if (gIdx === 0) { %>
              <form method="post" action="/sites/<%= site.id %>/databases/<%= d.id %>/delete" class="inline" onsubmit="return confirm('Delete database <%= d.name %>? This will DROP the database in MySQL. Cannot be undone.');">
                <button type="submit" class="btn btn-danger">Delete DB</button>
              </form>
              <% } %>
            </td>
          </tr>
            <% }); %>
          <% } else { %>
          <tr>
            <td><%= d.name %></td>
            <td>—</td>
            <td>—</td>
            <td>—</td>
            <td>
              <form method="post" action="/sites/<%= site.id %>/databases/<%= d.id %>/delete" class="inline" onsubmit="return confirm('Delete database <%= d.name %>? This will DROP the database in MySQL. Cannot be undone.');">
                <button type="submit" class="btn btn-danger">Delete DB</button>
              </form>
            </td>
          </tr>
          <% } %>
          <% }); %>
        </tbody>
      </table>
      <% } else { %>
      <p class="empty-msg">No databases yet for this site.</p>
      <% } %>
      <form method="post" action="/sites/<%= site.id %>/databases" style="margin-top:1rem;">
        <div class="form-row">
          <label>Database name</label>
          <input type="text" name="name" required pattern="[a-zA-Z0-9_]+" title="Letters, numbers, underscore only">
        </div>
        <div class="form-row">
          <label>Assign user</label>
          <select name="assign_user" id="assign_user">
            <option value="">— None —</option>
            <option value="new">— New user —</option>
            <% (typeof existingDbUsers !== 'undefined' ? existingDbUsers : []).forEach(function(u) { %>
            <option value="<%= u.id %>"><%= u.username %></option>
            <% }); %>
          </select>
        </div>
        <div class="form-row" id="row-new-user" style="display:none;">
          <label>New username</label>
          <input type="text" name="db_username" placeholder="Username for DB access" pattern="[a-zA-Z0-9_]+" title="Letters, numbers, underscore only">
        </div>
        <div class="form-row" id="row-new-password" style="display:none;">
          <label>Password (required for new user)</label>
          <input type="password" name="db_password" placeholder="User password">
        </div>
        <div class="form-row">
          <label>Privileges</label>
          <select name="privileges">
            <% (typeof privilegeOptions !== 'undefined' ? privilegeOptions : ['ALL','READ_WRITE','READ_ONLY']).forEach(function(p) { %>
            <option value="<%= p %>" <%= p === 'ALL' ? 'selected' : '' %>><%= p === 'ALL' ? 'All' : (p === 'READ_WRITE' ? 'Read / Write' : 'Read only') %></option>
            <% }); %>
          </select>
        </div>
        <button type="submit" class="btn">Add database</button>
      </form>
      <script>
        (function(){
          var sel = document.getElementById('assign_user');
          var rowUser = document.getElementById('row-new-user');
          var rowPwd = document.getElementById('row-new-password');
          if (!sel || !rowUser) return;
          function toggle(){
            var show = sel.value === 'new';
            rowUser.style.display = show ? 'block' : 'none';
            rowPwd.style.display = show ? 'block' : 'none';
            rowUser.querySelector('input').required = show;
            rowPwd.querySelector('input').required = show;
          }
          sel.addEventListener('change', toggle);
          toggle();
        })();
      </script>
      <% } %>
    </div>

    <div class="card">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>FTP users for this site</h2>
      <% if (!site.ftp_enabled) { %>
      <p class="empty-msg">Enable FTP for this site in <a href="/sites/<%= site.id %>/edit">Edit settings</a> to add FTP users.</p>
      <% } else { %>
      <% if (typeof newFtpCredentials !== 'undefined' && newFtpCredentials) {
        const newFtpLogin = (typeof site !== 'undefined' && site.domain) ? (site.domain.replace(/\./g, '_') + '_' + newFtpCredentials.username) : newFtpCredentials.username;
      %>
      <div class="credential-box">
        <strong>New FTP user created — save these credentials (shown once)</strong>
        Use <strong>FTP login</strong> in your client: <code><%= newFtpLogin %></code> · Password: <span class="password"><%= newFtpCredentials.password %></span>
        <button type="button" class="btn btn-small btn-secondary" onclick="var el=this.closest('.credential-box').querySelector('.password'); if(el && navigator.clipboard){ navigator.clipboard.writeText(el.textContent); this.textContent='Copied'; var t=this; setTimeout(function(){ t.textContent='Copy'; }, 1500); }">Copy password</button>
      </div>
      <% } %>
      <p class="empty-msg">Use the <strong>FTP login</strong> name (domain_username) in your FTP client, not the username alone.</p>
      <% if (ftpUsers.length) { %>
      <table>
        <thead><tr><th>Username</th><th>FTP login</th><th>Default route</th><th>Password</th><th></th></tr></thead>
        <tbody>
          <% ftpUsers.forEach(function(u) {
            const ftpLogin = (typeof site !== 'undefined' && site.domain) ? (site.domain.replace(/\./g, '_') + '_' + u.username) : u.username;
          %>
          <tr>
            <td><%= u.username %></td>
            <td><code><%= ftpLogin %></code></td>
            <td><%= (u.default_route && u.default_route !== '') ? u.default_route : '(docroot)' %></td>
            <td class="password-cell">
              <% if (!u.crypt_hash || u.crypt_hash === '') { %>
              <span class="show-hint">FTP login disabled — set password below to enable.</span>
              <% } else { %>
              <span class="pwd-mask">••••••</span>
              <button type="button" class="btn btn-small btn-secondary" onclick="var c=this.closest('.password-cell'); c.querySelector('.pwd-mask').style.display='none'; c.querySelector('.show-hint').style.display='inline'; this.style.display='none';">Show</button>
              <span class="show-hint" style="display:none;">Not stored — use Reset</span>
              <% } %>
              <form method="post" action="/sites/<%= site.id %>/ftp-users/<%= u.id %>/reset-password" class="inline">
                <input type="password" name="password" placeholder="New password" required style="max-width:10rem;" autocomplete="new-password">
                <button type="submit" class="btn btn-small">Reset</button>
              </form>
            </td>
            <td>
              <form method="post" action="/sites/<%= site.id %>/ftp-users/<%= u.id %>/delete" class="inline" onsubmit="return confirm('Remove FTP user <%= u.username %>?');">
                <button type="submit" class="btn btn-danger">Remove</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
      <% } else { %>
      <p class="empty-msg">No FTP users yet. Add one below; set the default route to restrict access to a subdirectory (e.g. / or /public).</p>
      <% } %>
      <form method="post" action="/sites/<%= site.id %>/ftp-users" style="margin-top:1rem;">
        <div class="form-row">
          <label>Username</label>
          <input type="text" name="username" required>
        </div>
        <div class="form-row">
          <label>Password</label>
          <input type="password" name="password" required>
        </div>
        <div class="form-row">
          <label>Default route</label>
          <input type="text" name="default_route" placeholder="e.g. / or /public (blank = site docroot)">
        </div>
        <button type="submit" class="btn">Add FTP user</button>
      </form>
      <% } %>
    </div>
  </main>
</body>
</html>
