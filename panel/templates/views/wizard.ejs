<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup wizard – Tinchost Panel</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #eef5ef; color: #1b4332; }
    <%- include('partials/nav-styles') %>
    .ic { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    main { max-width: 720px; margin: 0 auto; padding: 1.5rem; background: #fff; min-height: 80vh; border: 1px solid #b7d4bc; border-top: none; }
    .stack { background: #d8f3dc; border: 1px solid #95d5b2; border-radius: 6px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
    .stack h2 .ic { width: 16px; height: 16px; flex-shrink: 0; }
    .stack h2 { margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; color: #2d6a4f; text-transform: uppercase; letter-spacing: 0.03em; display: flex; align-items: center; gap: 0.4rem; }
    .stack ul { margin: 0; padding: 0; list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; }
    .stack li { font-size: 0.9rem; color: #1b4332; display: flex; align-items: center; gap: 0.35rem; }
    .stack li .ic { width: 14px; height: 14px; color: #2d6a4f; flex-shrink: 0; }
    .stack.empty li .ic { color: #95d5b2; }
    .stack.empty { opacity: 0.9; background: #f1f8f2; border-color: #cce3d0; }
    .risk { background: #fff8e1; border-left: 4px solid #b7a53a; padding: 0.75rem 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; font-size: 0.9rem; color: #5c4d1f; }
    pre { background: #1b4332; color: #d8f3dc; padding: 1rem; overflow-x: auto; border-radius: 6px; font-size: 0.85rem; border: 1px solid #2d6a4f; }
    input[type="checkbox"], input[type="radio"] { margin-right: 0.5rem; vertical-align: middle; accent-color: #2d6a4f; }
    label { cursor: pointer; }
    .checkbox-group { display: flex; flex-direction: column; gap: 0.5rem; margin: 0.75rem 0; }
    .checkbox-option { display: block; padding: 0.4rem 0; }
    .checkbox-option:hover { color: #2d6a4f; }
    button, .btn { padding: 0.5rem 1rem; cursor: pointer; background: #2d6a4f; color: #fff; border: none; border-radius: 6px; font-size: 1rem; }
    button:hover, .btn:hover { background: #1b4332; }
    .btn-secondary { background: #52796f; color: #fff; }
    .btn-secondary:hover { background: #354f52; }
    .btn-success { background: #2d6a4f; color: #fff; }
    .btn-success:hover { background: #1b4332; }
    .step-actions { margin-top: 1.5rem; display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
    .step-actions .btn { margin-right: 0; }
    .btn-back { color: #52796f; text-decoration: none; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.35rem; }
    .btn-back:hover { color: #1b4332; }
    .wizard-actions-disabled { opacity: 0.85; pointer-events: none; cursor: not-allowed; }
    .result-log { white-space: pre-wrap; max-height: 320px; overflow-y: auto; }
    .result-success { color: #2d6a4f; font-weight: 600; }
    .result-error { color: #9b2226; font-weight: 600; }
    .install-log-container { margin-top: 1rem; border: 1px solid #b7d4bc; border-radius: 6px; overflow: hidden; }
    .install-log { margin: 0; padding: 1rem; background: #1b4332; color: #d8f3dc; font-size: 0.8rem; max-height: 360px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; border: none; }
    .install-log-status { margin: 0.75rem 1rem 0; }
    .install-log-status.result-success { color: #2d6a4f; font-weight: 600; }
    .install-log-status.result-error { color: #9b2226; font-weight: 600; }
    .wizard-completion-summary { background: #d8f3dc; border: 1px solid #2d6a4f; border-radius: 6px; padding: 1.25rem; margin-top: 1rem; }
    .wizard-completion-summary h3 { margin: 0 0 0.5rem 0; color: #1b4332; font-size: 1.1rem; }
    .wizard-completion-summary p { margin: 0; color: #1b4332; }
    .wizard-completion-actions { margin-top: 1rem; }
    .wizard-completion-actions .btn { padding: 0.6rem 1.25rem; font-size: 1.05rem; }
    h1 { margin-top: 0; color: #1b4332; }
    .wizard-step { margin-bottom: 1rem; padding-bottom: 1rem; }
    .wizard-step form { display: block; }
    .wizard-step h2 { color: #2d6a4f; font-size: 1.1rem; }
    .wizard-subhead { font-size: 1rem; margin: 1.5rem 0 0.5rem 0; color: #1b4332; }
    .radio-group { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem; }
    .radio-option { display: block; padding: 0.75rem 1rem; border: 1px solid #b7d4bc; border-radius: 6px; cursor: pointer; background: #fff; }
    .radio-option:has(input:checked) { border-color: #2d6a4f; background: #f1f8f2; }
    .radio-option input { margin-right: 0.5rem; }
    .radio-label { font-weight: 600; display: block; margin-bottom: 0.25rem; color: #1b4332; }
    .radio-desc { font-size: 0.9rem; color: #52796f; display: block; }
  </style>
</head>
<body>
  <%- include('partials/nav') %>
  <main>
    <h1>Setup wizard</h1>
    <p>Choose what to install below. Your selection is summarized in <strong>Your stack</strong>. When you click <strong>Install all</strong>, the panel will install everything on this server and show a live log—you don’t need to run any commands yourself.</p>

    <% const phpList = (state.php_versions || '').split(',').map(s => s.trim()).filter(Boolean); %>
    <% const hasDb = state.database_choice; %>
    <% const nodeVer = state.node_version || ''; %>
    <% const phpConfigLabel = state.php_fpm_config === 'optimized' ? ' (optimized)' : ''; %>
    <% const dbConfigLabel = state.database_config === 'optimized' ? ' (optimized)' : ''; %>
    <% const opts = [ state.email_installed && 'Mail (Postfix + Dovecot)', state.ftp_installed && 'FTP (ProFTPD)', state.certbot_installed && 'Certbot (SSL)' ].filter(Boolean); %>
    <section class="stack <%= (phpList.length || hasDb || nodeVer || opts.length) ? '' : 'empty' %>" aria-label="Selected stack">
      <h2><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Your stack</h2>
      <ul>
        <% if (phpList.length) { phpList.forEach(v => { %><li><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg>PHP-FPM <%= v %><%= phpConfigLabel %></li><% }); } %>
        <% if (nodeVer) { %><li><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg>Node.js <%= nodeVer %></li><% } %>
        <% if (hasDb) { %><li><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg><%= hasDb === 'mariadb' ? 'MariaDB' : 'MySQL' %><%= dbConfigLabel %></li><% } %>
        <% opts.forEach(name => { %><li><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg><%= name %></li><% }); %>
        <% if (!phpList.length && !nodeVer && !hasDb && !opts.length) { %><li><svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><line x1="5" y1="12" x2="19" y2="12"/></svg>Nothing selected yet</li><% } %>
      </ul>
    </section>

    <% if (step === 'welcome' || !step) { %>
    <% const phpFpmConfig = state.php_fpm_config || 'default'; %>
    <% const defaultPhp = (phpList.length === 0 ? ['8.2'] : phpList); %>
    <div class="wizard-step">
      <h2>PHP-FPM versions</h2>
      <p>Select which PHP-FPM versions to install (sites can use different versions). Nginx will use the matching FastCGI socket for each site. You can select none, one, or several.</p>
      <form method="post" action="/wizard/php">
        <div class="checkbox-group">
          <label class="checkbox-option"><input type="checkbox" name="versions" value="7.4" <%= defaultPhp.includes('7.4') ? 'checked' : '' %>> PHP-FPM 7.4</label>
          <label class="checkbox-option"><input type="checkbox" name="versions" value="8.1" <%= defaultPhp.includes('8.1') ? 'checked' : '' %>> PHP-FPM 8.1</label>
          <label class="checkbox-option"><input type="checkbox" name="versions" value="8.2" <%= defaultPhp.includes('8.2') ? 'checked' : '' %>> PHP-FPM 8.2</label>
          <label class="checkbox-option"><input type="checkbox" name="versions" value="8.3" <%= defaultPhp.includes('8.3') ? 'checked' : '' %>> PHP-FPM 8.3</label>
        </div>

        <h3 class="wizard-subhead">PHP-FPM configuration</h3>
        <p>Choose how PHP-FPM is tuned for this server.</p>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="php_fpm_config" value="default" <%= phpFpmConfig === 'default' ? 'checked' : '' %>>
            <span class="radio-label">Default</span>
            <span class="radio-desc">Use the package defaults. Lower memory use, good for development or low-traffic sites.</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="php_fpm_config" value="optimized" <%= phpFpmConfig === 'optimized' ? 'checked' : '' %>>
            <span class="radio-label">Optimized</span>
            <span class="radio-desc">Production-oriented tuning: larger worker pool (pm.max_children 50, dynamic pm), worker recycling (pm.max_requests 500), and OPcache with 128MB, 10k cached scripts and no runtime file checks for best throughput.</span>
          </label>
        </div>

        <h3 class="wizard-subhead">Node.js version</h3>
        <p>Select which Node.js version to install (for Node-type sites). Choose one: latest LTS or two versions behind. You can skip Node if you only use PHP.</p>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="node_version" value="" <%= !state.node_version || state.node_version === '' ? 'checked' : '' %>>
            <span class="radio-label">Don't install Node.js</span>
            <span class="radio-desc">Skip Node. You can add it later or use PHP-only sites.</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="node_version" value="22" <%= state.node_version === '22' ? 'checked' : '' %>>
            <span class="radio-label">Node.js 22 (Latest LTS)</span>
            <span class="radio-desc">Current LTS. Recommended for new projects.</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="node_version" value="20" <%= state.node_version === '20' ? 'checked' : '' %>>
            <span class="radio-label">Node.js 20 (One version behind)</span>
            <span class="radio-desc">Previous LTS. Use for compatibility with existing apps.</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="node_version" value="18" <%= state.node_version === '18' ? 'checked' : '' %>>
            <span class="radio-label">Node.js 18 (Two versions behind)</span>
            <span class="radio-desc">Older LTS. Use only if you need this specific version.</span>
          </label>
        </div>

        <div class="step-actions">
          <button type="submit">Next: Database</button>
        </div>
      </form>
    </div>
    <% } %>

    <% if (step === 'database') { %>
    <% const databaseConfig = state.database_config || 'default'; %>
    <div class="wizard-step">
      <h2>Database</h2>
      <p>Choose MySQL or MariaDB. The panel can create databases and users if the root password is set in Settings.</p>
      <form method="post" action="/wizard/database">
        <label><input type="radio" name="choice" value="mysql" <%= state.database_choice !== 'mariadb' ? 'checked' : '' %>> MySQL 8</label>
        <label><input type="radio" name="choice" value="mariadb" <%= state.database_choice === 'mariadb' ? 'checked' : '' %>> MariaDB 10</label>

        <h3 class="wizard-subhead">Database configuration</h3>
        <p>Choose how the database engine is tuned.</p>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="database_config" value="default" <%= databaseConfig === 'default' ? 'checked' : '' %>>
            <span class="radio-label">Default</span>
            <span class="radio-desc">Use the package defaults. Suited for development or light workloads.</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="database_config" value="optimized" <%= databaseConfig === 'optimized' ? 'checked' : '' %>>
            <span class="radio-label">Optimized</span>
            <span class="radio-desc">InnoDB tuning for production: 256M buffer pool, 64M log file, reduced durability for throughput (innodb_flush_log_at_trx_commit=2), O_DIRECT for I/O. Same settings apply to MySQL or MariaDB.</span>
          </label>
        </div>

        <div class="step-actions">
          <a href="/wizard/step/welcome" class="btn-back">← Back to PHP-FPM</a>
          <button type="submit">Next: Optional services</button>
        </div>
      </form>
    </div>
    <% } %>

    <% if (step === 'options') { %>
    <div class="wizard-step">
      <h2>Optional services</h2>
      <p>Optionally add mail (Postfix + Dovecot), FTP (ProFTPD), and Certbot for Let's Encrypt. All selected components will be installed together on the next step.</p>
      <form method="post" action="/wizard/options">
        <label><input type="checkbox" name="install_email" value="1" <%= state.email_installed ? 'checked' : '' %>> Mail (Postfix + Dovecot)</label><br>
        <label><input type="checkbox" name="install_ftp" value="1" <%= state.ftp_installed ? 'checked' : '' %>> FTP (ProFTPD)</label><br>
        <label><input type="checkbox" name="install_certbot" value="1" <%= state.certbot_installed ? 'checked' : '' %>> Certbot (Let's Encrypt)</label>
        <div class="step-actions">
          <a href="/wizard/step/database" class="btn-back">← Back to Database</a>
          <button type="submit">Next: Review &amp; install</button>
        </div>
      </form>
    </div>
    <% } %>

    <% if (step === 'review') { %>
    <div class="wizard-step">
      <h2>Review &amp; install</h2>
      <p>Everything in <strong>Your stack</strong> will be installed on this server when you click <strong>Install all</strong>. A live log will appear below; installation may take several minutes. You can go back to change your choices until you start the installation.</p>
      <div id="wizard-review-actions" class="step-actions">
        <a href="/wizard/step/options" id="wizard-back-link" class="btn-back">← Back to Optional services</a>
        <button type="button" id="wizard-install-btn" class="btn-success">Install all</button>
      </div>
      <div id="wizard-log-container" class="install-log-container" hidden>
        <pre id="wizard-log" class="install-log"></pre>
        <p id="wizard-log-status" class="install-log-status" hidden></p>
        <div id="wizard-completion-summary" class="wizard-completion-summary" hidden>
          <h3><svg class="ic" viewBox="0 0 24 24" aria-hidden="true" style="width:20px;height:20px;vertical-align:middle;margin-right:0.35rem;"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Installation complete</h3>
          <p>All selected components were installed successfully. You can now use the dashboard to manage sites, databases, and optional services.</p>
          <div class="wizard-completion-actions">
            <a href="/" class="btn btn-success">Go to dashboard</a>
          </div>
        </div>
        <div id="wizard-log-actions" class="step-actions" hidden>
          <a href="/" class="btn btn-success">Go to dashboard</a>
          <a href="/wizard" class="btn btn-secondary">Back to wizard</a>
        </div>
      </div>
    </div>
    <script>
(function() {
  var btn = document.getElementById('wizard-install-btn');
  var reviewActions = document.getElementById('wizard-review-actions');
  var backLink = document.getElementById('wizard-back-link');
  var container = document.getElementById('wizard-log-container');
  var logEl = document.getElementById('wizard-log');
  var statusEl = document.getElementById('wizard-log-status');
  var summaryEl = document.getElementById('wizard-completion-summary');
  var actionsEl = document.getElementById('wizard-log-actions');
  if (!btn || !container) return;

  function setInstalling(disabled) {
    reviewActions.classList.toggle('wizard-actions-disabled', disabled);
    btn.disabled = disabled;
    btn.textContent = disabled ? 'Installing…' : 'Install all';
    if (backLink) {
      backLink.style.pointerEvents = disabled ? 'none' : '';
      backLink.style.opacity = disabled ? '0.5' : '';
      backLink.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    }
  }

  function preventBack(e) { e.preventDefault(); }

  btn.addEventListener('click', function() {
    setInstalling(true);
    if (backLink) backLink.addEventListener('click', preventBack);
    container.hidden = false;
    logEl.textContent = '';
    statusEl.hidden = true;
    actionsEl.hidden = true;
    var buffer = '';
    fetch('/wizard/install/stream', { method: 'POST', headers: { 'Accept': 'text/event-stream' } })
      .then(function(res) {
        if (!res.ok) throw new Error('Install request failed');
        return res.body.getReader();
      })
      .then(function(reader) {
        function read() {
          return reader.read().then(function(r) {
            if (r.done) return;
            buffer += new TextDecoder().decode(r.value, { stream: true });
            var parts = buffer.split('\n\n');
            buffer = parts.pop() || '';
            parts.forEach(function(block) {
              var match = block.match(/^data:\s*(.+)/m);
              if (match) {
                try {
                  var data = JSON.parse(match[1]);
                  if (data.msg) {
                    logEl.textContent += data.msg;
                    logEl.scrollTop = logEl.scrollHeight;
                  }
                  if (data.done) {
                    setInstalling(false);
                    if (backLink) backLink.removeEventListener('click', preventBack);
                    btn.hidden = true;
                    if (data.success) {
                      if (summaryEl) summaryEl.hidden = false;
                      statusEl.hidden = true;
                      actionsEl.hidden = true;
                    } else {
                      statusEl.hidden = false;
                      statusEl.textContent = 'Installation finished with errors. Check the log above.';
                      statusEl.className = 'install-log-status result-error';
                      actionsEl.hidden = false;
                      if (summaryEl) summaryEl.hidden = true;
                    }
                  }
                } catch (_) {}
              }
            });
            return read();
          });
        }
        return read();
      })
      .catch(function(err) {
        logEl.textContent += '\nError: ' + (err.message || String(err));
        setInstalling(false);
        if (backLink) backLink.removeEventListener('click', preventBack);
        statusEl.hidden = false;
        statusEl.textContent = 'Installation failed.';
        statusEl.className = 'install-log-status result-error';
        actionsEl.hidden = false;
        btn.disabled = false;
        btn.textContent = 'Install all';
      });
  });
})();
    </script>
    <% } %>

    <% if (step === 'result') { %>
    <div class="wizard-step">
      <h2>Installation result</h2>
      <% if (typeof success !== 'undefined' && success) { %>
        <p class="result-success">All selected components were installed successfully.</p>
      <% } else { %>
        <p class="result-error">Installation reported errors. Check the log below. You can fix issues and run the wizard again or install packages manually.</p>
      <% } %>
      <% if (typeof log !== 'undefined' && log) { %>
        <pre class="result-log"><%= log %></pre>
      <% } %>
      <div class="step-actions">
        <a href="/" class="btn btn-success">Go to dashboard</a>
        <a href="/wizard" class="btn btn-secondary">Back to wizard</a>
      </div>
    </div>
    <% } %>

    <% if (step === 'finish') { %>
    <div class="wizard-step">
      <p>Wizard complete. You can change paths and options in Settings.</p>
      <div class="step-actions">
        <a href="/" class="btn btn-success">Go to dashboard</a>
      </div>
    </div>
    <% } %>
  </main>
</body>
</html>
